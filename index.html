<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kennis Battle</title>

<style>
:root{
  --A:#4f7cff;
  --B:#ef4444;
  --ink:#111;
  --muted:#6b7280;
  --border:rgba(0,0,0,.12);
  --shadow:0 12px 34px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#fff;
  color:var(--ink);
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  overflow:hidden;
}

.topTitle{
  position:fixed;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  font-size:22px;
  font-weight:950;
  letter-spacing:.2px;
  z-index:3000;
  pointer-events:none;
}

.teacherBtn{
  position:fixed;
  top:10px;
  right:10px;
  z-index:3500;
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#111;
  color:#fff;
  font-weight:950;
  cursor:pointer;
  font-size:13px;
}

.wrap{
  max-width:1100px;
  height:100vh;
  margin:0 auto;
  padding:52px 10px 10px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:10px;
}

.topRow{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:0;
}

.teamCard{
  border:1px solid rgba(0,0,0,.12);
  background:#fff;
  padding:16px 20px;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:8px;
  min-width:280px;
  transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
}

.teamCard .score{
  font-size:32px;
  font-weight:1000;
  line-height:1;
  color:#111;
}

.nameRow{
  display:flex;
  align-items:center;
  gap:8px;
  width:100%;
}

.nameInput{
  flex:1;
  text-align:center;
  font-weight:600;
  font-size:16px;
  border:1px solid rgba(0,0,0,.10);
  border-radius:10px;
  padding:10px 14px;
  outline:none;
  user-select:text;
  background:#fff;
  color:#666;
  transition: border-color .15s ease;
}
.nameInput::placeholder{ color:#999; }
.nameInput:focus{ border-color:rgba(0,0,0,.25); }

.main{
  display:grid;
  grid-template-rows:auto auto auto;
  gap:10px;
  min-height:0;
  align-items:stretch;
}

.videoStage{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:8px;
  min-height:0;
}

.videoBox{
  width:min(640px, 100%);
  aspect-ratio:16/9;
  max-height:44vh;
  border-radius:16px;
  overflow:hidden;
  background:#000;
  box-shadow:var(--shadow);
  position:relative;
}
#playerHost{ position:absolute; inset:0; }
.videoBox iframe, .videoBox video{
  width:100%;
  height:100%;
  border:0;
  display:block;
  pointer-events:none;
}
.videoBox video.interactive{
  pointer-events:auto;
}

.playOverlay{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  background:linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.28));
  z-index:5;
}
.playBtn{
  border:0;
  cursor:pointer;
  padding:14px 18px;
  border-radius:16px;
  font-weight:1000;
  font-size:16px;
  background:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  display:flex;
  align-items:center;
  gap:10px;
}
.playIcon{
  width:0;height:0;
  border-top:9px solid transparent;
  border-bottom:9px solid transparent;
  border-left:14px solid #111;
}

.videoControls{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.ctrlBtn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:950;
  cursor:pointer;
  font-size:13px;
}
.ctrlBtn.primary{ background:#111; color:#fff; border-color:transparent}
.ctrlBtn:disabled{ opacity:.45; cursor:not-allowed; }

.qa{
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:8px;
  min-height:0;
  background:#fff;
}
.question{
  text-align:center;
  font-size:16px;
  font-weight:1000;
  line-height:1.2;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px 4px;
  border:1px solid rgba(0,0,0,.06);
  border-radius:12px;
  min-height:46px;
}

.answers{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.col{
  display:grid;
  grid-template-rows:1fr 1fr;
  gap:8px;
  align-items:stretch;
}
.answer{
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:950;
  cursor:pointer;
  background:#fff;
  padding:10px 12px 10px 14px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  text-align:left;
  line-height:1.15;
  min-height:60px;
  font-size:14px;
}
.answer:hover{ background:#f9fafb; }
.answer.disabled{ opacity:.45; pointer-events:none; }
.answer.correct{ background:#dcfce7; border-color:rgba(22,163,74,.55); }
.answer.wrong{ background:#fee2e2; border-color:rgba(220,38,38,.55); }

.bottomControls{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.btn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  font-size:13px;
}

/* Teacher panel */
.teacherPanel{
  position:fixed;
  right:10px;
  top:50px;
  bottom:10px;
  width:340px;
  max-height:calc(100vh - 60px);
  overflow-y:auto;
  background:#fff;
  border:1px solid rgba(0,0,0,.15);
  border-radius:16px;
  padding:12px;
  box-shadow:0 12px 34px rgba(0,0,0,.12);
  z-index:3600;
  display:none;
}
.teacherPanel.open{ display:block; }

.tpTop{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.tpTop .title{font-weight:1000;font-size:13px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.lockPill{
  font-size:10px;
  font-weight:1000;
  padding:3px 6px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f8fafc;
  color:#111;
}
.savePill{
  font-size:11px;
  font-weight:1000;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#fff;
  color:#111;
}
.tpTop .close{border:1px solid var(--border);background:#fff;border-radius:8px;padding:5px 8px;font-weight:950;cursor:pointer;font-size:13px}

.tpNav{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-bottom:12px;
  padding:8px;
  background:#f5f5f5;
  border-radius:10px;
}
.tpRoundInfo{
  font-weight:1000;
  font-size:14px;
  min-width:40px;
  text-align:center;
}
.tpNavSpacer{
  flex:1;
}
.btnSmall{
  padding:6px 10px;
  font-size:12px;
}

label{display:block;font-size:11px;font-weight:900;color:var(--muted);margin:7px 0 5px}
input.tp,textarea.tp{
  width:100%;
  padding:9px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  font:inherit;
  user-select:text;
  outline:none;
  font-size:13px;
}
textarea.tp{min-height:66px;resize:vertical}
.tpGrid{display:grid;grid-template-columns:1fr;gap:9px}
.tpActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:9px}
.tpActions .btn{flex:1;min-width:80px;text-align:center}
.btnPrimary{ background:#111; color:#fff; border-color:transparent; }
.smallHint{font-size:11px;color:var(--muted);margin-top:6px}

.videoHint{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  line-height:1.4;
  background:#f8fafc;
  padding:8px 10px;
  border-radius:8px;
}
.videoHint strong{ color:#111; }

/* Export/Import section */
.exportSection{
  margin-top:14px;
  padding-top:14px;
  border-top:1px solid var(--border);
}
.exportSection .sectionTitle{
  font-weight:1000;
  font-size:12px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}
.exportBtns{
  display:flex;
  gap:8px;
  flex-direction:column;
  margin-bottom:10px;
}
.importArea{
  display:none;
  margin-top:10px;
}
.importArea.show{ display:block; }
.importArea textarea{
  width:100%;
  min-height:80px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  font-family:monospace;
  font-size:12px;
  resize:vertical;
}
.importActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.importActions .btn{
  flex:1;
  min-width:80px;
  text-align:center;
}

.footer{
  position:fixed;
  bottom:10px;
  right:14px;
  font-size:11px;
  color:var(--muted);
  z-index:2000;
}

.winnerModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:5000;
  place-items:center;
}
.winnerModal.show{
  display:grid;
}
.winnerBox{
  background:#fff;
  border-radius:20px;
  padding:32px 48px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.winnerTitle{
  font-size:24px;
  font-weight:900;
  margin-bottom:8px;
}
.winnerName{
  font-size:36px;
  font-weight:1000;
  margin-bottom:8px;
}
.winnerScore{
  font-size:20px;
  font-weight:700;
  color:#666;
  margin-bottom:20px;
}
.winnerModal .btn{
  padding:12px 24px;
  font-size:15px;
}

/* Hidden file input */
#importFileInput{
  display:none;
}

/* Password modal */
.passwordModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:6000;
  place-items:center;
}
.passwordModal.show{
  display:grid;
}
.passwordBox{
  background:#fff;
  border-radius:16px;
  padding:24px 32px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  min-width:280px;
}
.passwordTitle{
  font-size:16px;
  font-weight:900;
  margin-bottom:16px;
}
.passwordInput{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:16px;
  text-align:center;
  outline:none;
  letter-spacing:4px;
}
.passwordInput:focus{
  border-color:rgba(0,0,0,.3);
}
.passwordActions{
  display:flex;
  gap:8px;
  margin-top:16px;
  justify-content:center;
}
.passwordActions .btn{
  flex:1;
}
</style>
</head>

<body>

<div class="topTitle">Kennis Battle</div>
<button class="teacherBtn" id="teacherBtn" type="button">Teacher</button>

<div class="wrap" id="app">
  <div class="topRow">
    <div class="teamCard" id="cardA">
      <div class="score" id="scoreA">0</div>
      <div class="nameRow">
        <input class="nameInput" id="nameAInput" placeholder="Naam" value="" maxlength="18" aria-label="Naam team A">
      </div>
    </div>

    <div class="teamCard" id="cardB">
      <div class="score" id="scoreB">0</div>
      <div class="nameRow">
        <input class="nameInput" id="nameBInput" placeholder="Naam" value="" maxlength="18" aria-label="Naam team B">
      </div>
    </div>
  </div>

  <div class="main">
    <div class="videoStage">
      <div class="videoBox">
        <div id="playerHost"></div>

        <div class="playOverlay" id="playOverlay">
          <button class="playBtn" id="playBtn" type="button">
            <span class="playIcon"></span>
            <span id="playText">Start video</span>
          </button>
        </div>
      </div>

      <div class="videoControls">
        <button class="ctrlBtn" id="nextQuestion" type="button">Next</button>
        <button class="ctrlBtn primary" id="btnPlay" type="button">Play</button>
        <button class="ctrlBtn" id="btnStop" type="button" disabled>Stop</button>
      </div>
    </div>

    <div class="qa">
      <div class="question" id="question">‚Äî</div>
      <div class="answers">
        <div class="col" id="colLeft"></div>
        <div class="col" id="colRight"></div>
      </div>
    </div>

    <div class="bottomControls">
      <div id="roundInfo">Ronde 1/1</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="resetScore" type="button">Reset spel</button>
      </div>
    </div>
  </div>
</div>

<div class="teacherPanel" id="teacherPanel" aria-hidden="true">
  <div class="tpTop">
    <div class="title">
      Teacher
      <span class="lockPill" id="lockPill">locked</span>
      <span class="savePill" id="savePill">Saved ‚úì</span>
    </div>
    <button class="close" id="tpClose" type="button">‚úï</button>
  </div>

  <div class="tpNav">
    <button class="btn" id="prev" type="button">‚óÄ</button>
    <span class="tpRoundInfo" id="tpRoundInfo">1/1</span>
    <button class="btn" id="next" type="button">‚ñ∂</button>
    <span class="tpNavSpacer"></span>
    <button class="btn btnSmall" id="moveUp" type="button" title="Omhoog">‚Üë</button>
    <button class="btn btnSmall" id="moveDown" type="button" title="Omlaag">‚Üì</button>
  </div>

  <div class="tpGrid">
    <div>
      <label>Video URL</label>
      <input class="tp" id="tpVideo" placeholder="YouTube, Vimeo, MP4, of embed URL">
      <div class="videoHint">
        <strong>Ondersteund:</strong><br>
        ‚Ä¢ YouTube: youtu.be/xxx of youtube.com/watch?v=xxx<br>
        ‚Ä¢ Vimeo: vimeo.com/123456789<br>
        ‚Ä¢ Direct: .mp4, .webm, .ogg bestanden<br>
        ‚Ä¢ Embed: elke iframe embed URL
      </div>
    </div>

    <div>
      <label>Vraag</label>
      <textarea class="tp" id="tpQuestion" placeholder="Typ je vraag..."></textarea>
    </div>

    <div><label>Antwoord A</label><input class="tp" id="tpA"></div>
    <div><label>Antwoord B</label><input class="tp" id="tpB"></div>
    <div><label>Antwoord C</label><input class="tp" id="tpC"></div>
    <div><label>Antwoord D</label><input class="tp" id="tpD"></div>

    <div>
      <label>Correct (A/B/C/D)</label>
      <input class="tp" id="tpCorrect" placeholder="A">
    </div>
  </div>

  <div class="tpActions">
    <button class="btn btnPrimary" id="saveRound" type="button">Save</button>
    <button class="btn" id="addRound" type="button">Add</button>
    <button class="btn" id="deleteRound" type="button">Delete</button>
  </div>

  <!-- Export/Import Section -->
  <div class="exportSection">
    <div class="sectionTitle">
      Delen & Importeren
    </div>
    <div class="exportBtns">
      <button class="btn" id="exportDownload" type="button">Download als bestand</button>
      <button class="btn" id="importShow" type="button">Importeer rondes</button>
    </div>
    
    <div class="importArea" id="importArea">
      <label>Plak data of kies bestand:</label>
      <div style="margin-bottom:8px">
        <button class="btn" id="importFileBtn" type="button">Kies bestand</button>
        <input type="file" id="importFileInput" accept=".json,.txt">
      </div>
      <textarea id="importData" placeholder='Plak JSON data...'></textarea>
      <div class="importActions">
        <button class="btn btnPrimary" id="importReplace" type="button">Vervang</button>
        <button class="btn btnPrimary" id="importAdd" type="button">Toevoegen</button>
        <button class="btn" id="importCancel" type="button">Annuleer</button>
      </div>
    </div>
  </div>

  <!-- Server Section -->
  <div class="exportSection">
    <div class="sectionTitle">
      Server
    </div>
    <div class="exportBtns">
      <button class="btn" id="reloadServer" type="button">üîÑ Herlaad van server</button>
    </div>
    <div class="smallHint" id="serverStatus">‚Äî</div>
  </div>
</div>

<div class="footer">Muziek met meester Luis</div>

<div class="winnerModal" id="winnerModal">
  <div class="winnerBox">
    <div class="winnerTitle" id="winnerTitle">üèÜ Winnaar!</div>
    <div class="winnerName" id="winnerName">Team A</div>
    <div class="winnerScore" id="winnerScore">5 - 3</div>
    <button class="btn btnPrimary" id="closeWinner" type="button">Sluiten</button>
  </div>
</div>

<div class="passwordModal" id="passwordModal">
  <div class="passwordBox">
    <div class="passwordTitle">Teacher wachtwoord</div>
    <input type="password" class="passwordInput" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
    <div class="passwordActions">
      <button class="btn" id="passwordCancel" type="button">Annuleer</button>
      <button class="btn btnPrimary" id="passwordSubmit" type="button">OK</button>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // CONFIGURATION
  // =========================
  const TEACHER_PASSWORD = "muziek"; // verander dit
  
  // URL naar je vragen JSON bestand (elke server)
  // Bijvoorbeeld: https://jouwsite.nl/questions.json
  const QUESTIONS_URL = "";
  
  let teacherUnlocked = false;

  const STORAGE = "kennis_battle_rounds_v9";
  const SCORE_KEY = "kennis_battle_scores_v9";
  const NAMES_KEY = "kennis_battle_names_v9";

  const el = id => document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  // =========================
  // VIDEO SOURCE DETECTION
  // =========================
  const VideoType = {
    YOUTUBE: 'youtube',
    VIMEO: 'vimeo',
    DIRECT: 'direct',
    EMBED: 'embed',
    NONE: 'none'
  };

  function detectVideoSource(url) {
    if (!url || typeof url !== 'string') {
      return { type: VideoType.NONE, id: '', url: '' };
    }
    
    url = url.trim();
    
    // YouTube detection
    const ytPatterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([\w-]+)/,
      /^([\w-]{11})$/ // Just the ID
    ];
    
    for (const pattern of ytPatterns) {
      const match = url.match(pattern);
      if (match) {
        return { type: VideoType.YOUTUBE, id: match[1], url: url };
      }
    }
    
    // Vimeo detection
    const vimeoPatterns = [
      /vimeo\.com\/(\d+)/,
      /player\.vimeo\.com\/video\/(\d+)/
    ];
    
    for (const pattern of vimeoPatterns) {
      const match = url.match(pattern);
      if (match) {
        return { type: VideoType.VIMEO, id: match[1], url: url };
      }
    }
    
    // Direct video file detection
    const videoExtensions = /\.(mp4|webm|ogg|mov|m4v)(\?.*)?$/i;
    if (videoExtensions.test(url)) {
      return { type: VideoType.DIRECT, id: '', url: url };
    }
    
    // Generic embed URL (anything with http/https that's not caught above)
    if (/^https?:\/\//i.test(url)) {
      return { type: VideoType.EMBED, id: '', url: url };
    }
    
    return { type: VideoType.NONE, id: '', url: '' };
  }

  // -------------------------
  // save pill
  // -------------------------
  let teacherSaveTimer = null;
  function markTeacherSaving(){
    el("savePill").textContent = "Saving‚Ä¶";
    clearTimeout(teacherSaveTimer);
    teacherSaveTimer = setTimeout(() => {
      el("savePill").textContent = "Saved ‚úì";
    }, 350);
  }

  function setLockUI(){
    el("lockPill").textContent = teacherUnlocked ? "unlocked" : "locked";
    el("teacherPanel").setAttribute("aria-hidden", teacherUnlocked ? "false" : "true");
  }

  // --- Teacher toggle with password ---
  function showPasswordModal() {
    el("passwordModal").classList.add("show");
    el("passwordInput").value = "";
    el("passwordInput").focus();
  }
  
  function hidePasswordModal() {
    el("passwordModal").classList.remove("show");
    el("passwordInput").value = "";
  }
  
  function checkPassword() {
    const pw = el("passwordInput").value;
    if (pw === TEACHER_PASSWORD) {
      teacherUnlocked = true;
      setLockUI();
      hidePasswordModal();
      el("teacherPanel").classList.add("open");
    } else {
      alert("Onjuist wachtwoord");
      el("passwordInput").value = "";
      el("passwordInput").focus();
    }
  }
  
  el("teacherBtn").addEventListener("click", () => {
    if(!teacherUnlocked){
      showPasswordModal();
      return;
    }
    el("teacherPanel").classList.toggle("open");
  });
  
  el("passwordSubmit").addEventListener("click", checkPassword);
  el("passwordCancel").addEventListener("click", hidePasswordModal);
  el("passwordInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkPassword();
    if (e.key === "Escape") hidePasswordModal();
  });
  
  el("tpClose").addEventListener("click", () => el("teacherPanel").classList.remove("open"));

  // --- Helpers ---
  function isValidRound(r){
    const source = detectVideoSource(r.videoUrl || r.videoId);
    if(source.type === VideoType.NONE) return false;
    if(!r.q) return false;
    if(!Array.isArray(r.a) || r.a.filter(Boolean).length < 2) return false;
    return true;
  }
  function cleanName(s){ return String(s||"").trim().slice(0,18); }

  function saveNames(){
    localStorage.setItem(NAMES_KEY, JSON.stringify({
      a: cleanName(el("nameAInput").value),
      b: cleanName(el("nameBInput").value),
    }));
  }
  el("nameAInput").addEventListener("input", saveNames);
  el("nameBInput").addEventListener("input", saveNames);

  // --- Migrate old rounds format ---
  function migrateRound(r) {
    // If round has old videoId format, convert to videoUrl
    if (r.videoId && !r.videoUrl) {
      const source = detectVideoSource(r.videoId);
      if (source.type === VideoType.YOUTUBE) {
        r.videoUrl = `https://youtu.be/${source.id}`;
      } else {
        r.videoUrl = r.videoId;
      }
    }
    return r;
  }

  // --- Load rounds from server or localStorage ---
  let rounds = [];
  
  async function fetchRoundsFromServer() {
    if (!QUESTIONS_URL) return null;
    
    try {
      const response = await fetch(QUESTIONS_URL, { cache: "no-store" });
      if (!response.ok) throw new Error("Fetch failed");
      const data = await response.json();
      if (Array.isArray(data) && data.length > 0) {
        return data.map(migrateRound);
      }
    } catch (e) {
      console.warn("Could not load from server:", e);
    }
    return null;
  }
  
  function loadRoundsFromStorage() {
    try {
      const stored = JSON.parse(localStorage.getItem(STORAGE));
      if (Array.isArray(stored) && stored.length > 0) {
        return stored.map(migrateRound);
      }
    } catch (_) {}
    return null;
  }
  
  function getDefaultRounds() {
    return [{
      videoUrl: "https://youtu.be/QV4tivE8vYo",
      q: "Welk instrument hoor je?",
      a: ["Trompet", "Trombone", "Hoorn", "Tuba"],
      c: 0
    }];
  }
  
  async function initRounds() {
    // Try server first
    const serverRounds = await fetchRoundsFromServer();
    if (serverRounds) {
      rounds = serverRounds;
      localStorage.setItem(STORAGE, JSON.stringify(rounds));
      console.log("Loaded", rounds.length, "rounds from server");
      return;
    }
    
    // Fall back to localStorage
    const storedRounds = loadRoundsFromStorage();
    if (storedRounds) {
      rounds = storedRounds;
      console.log("Loaded", rounds.length, "rounds from localStorage");
      return;
    }
    
    // Use defaults
    rounds = getDefaultRounds();
    localStorage.setItem(STORAGE, JSON.stringify(rounds));
    console.log("Using default rounds");
  }

  // --- Load names ---
  try{
    const n = JSON.parse(localStorage.getItem(NAMES_KEY) || "{}");
    if(typeof n.a === "string") el("nameAInput").value = cleanName(n.a);
    if(typeof n.b === "string") el("nameBInput").value = cleanName(n.b);
  }catch(_){}

  // --- Scores ---
  let scoreA = 0, scoreB = 0;
  try{
    const s = JSON.parse(localStorage.getItem(SCORE_KEY) || "{}");
    if(typeof s.a === "number") scoreA = s.a;
    if(typeof s.b === "number") scoreB = s.b;
  }catch(_){}
  el("scoreA").textContent = String(scoreA);
  el("scoreB").textContent = String(scoreB);

  // --- Turn logic ---
  let idx = 0;
  let answered = false;

  function renderAnswers(feedbackIndex=null){
    const r = rounds[idx];
    const letters = ["A","B","C","D"];
    const colL = el("colLeft");
    const colR = el("colRight");
    colL.innerHTML = "";
    colR.innerHTML = "";

    function makeBtn(n){
      const d = document.createElement("div");
      d.className = "answer";
      d.textContent = `${letters[n]}: ${(r.a && r.a[n]) ? r.a[n] : "‚Äî"}`;
      d.addEventListener("click", ()=>choose(n));

      if(answered){
        d.classList.add("disabled");
        if(n === r.c) d.classList.add("correct");
        if(feedbackIndex !== null && n === feedbackIndex && n !== r.c) d.classList.add("wrong");
      }
      return d;
    }

    colL.appendChild(makeBtn(0));
    colL.appendChild(makeBtn(2));
    colR.appendChild(makeBtn(1));
    colR.appendChild(makeBtn(3));
  }

  function resetRoundUI(){
    answered = false;
    renderAnswers();
    el("question").textContent = rounds[idx].q || "‚Äî";
  }

  // =========================
  // MULTI-SOURCE VIDEO PLAYER
  // =========================
  let ytReady = false;
  let ytPlayer = null;
  let ytPlayerIsReady = false;
  let htmlVideoEl = null;
  let currentVideoSource = { type: VideoType.NONE, id: '', url: '' };
  let isPaused = false;

  function setStopEnabled(on){ el("btnStop").disabled = !on; }
  function setOverlayText(){ el("playText").textContent = isPaused ? "Verder kijken" : "Start video"; }

  function loadYTApi(){
    return new Promise((resolve) => {
      if(ytReady && window.YT && window.YT.Player) return resolve();
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
      window.onYouTubeIframeAPIReady = () => { ytReady = true; resolve(); };
    });
  }

  function clearPlayer() {
    // Clear YouTube player
    if (ytPlayer && ytPlayer.destroy) {
      try { ytPlayer.destroy(); } catch(_) {}
      ytPlayer = null;
      ytPlayerIsReady = false;
    }
    // Clear HTML video
    if (htmlVideoEl) {
      htmlVideoEl.pause();
      htmlVideoEl.remove();
      htmlVideoEl = null;
    }
    // Clear any iframes or content
    el("playerHost").innerHTML = "";
  }

  async function createYouTubePlayer(videoId) {
    await loadYTApi();
    
    return new Promise((resolve) => {
      ytPlayer = new YT.Player("playerHost", {
        videoId,
        playerVars: {
          controls: 0,
          fs: 0,
          rel: 0,
          modestbranding: 1,
          iv_load_policy: 3,
          disablekb: 1,
          playsinline: 1,
          autoplay: 0
        },
        events: {
          onReady: () => { 
            ytPlayerIsReady = true; 
            setStopEnabled(true);
            resolve();
          },
          onStateChange: (e) => {
            if(!window.YT) return;
            if(e.data === YT.PlayerState.PAUSED){ 
              isPaused = true; 
              setOverlayText(); 
              el("playOverlay").style.display = "grid"; 
            }
            if(e.data === YT.PlayerState.PLAYING){
              isPaused = false; 
              setOverlayText();
              el("playOverlay").style.display = "none";
            }
            if(e.data === YT.PlayerState.ENDED){
              isPaused = false; 
              setOverlayText();
              el("playOverlay").style.display = "grid";
            }
          }
        }
      });
    });
  }

  function createVimeoPlayer(videoId) {
    const iframe = document.createElement("iframe");
    iframe.src = `https://player.vimeo.com/video/${videoId}?autoplay=0&title=0&byline=0&portrait=0`;
    iframe.allow = "autoplay; fullscreen";
    iframe.style.cssText = "width:100%;height:100%;border:0;";
    el("playerHost").appendChild(iframe);
    setStopEnabled(true);
    return iframe;
  }

  function createDirectVideoPlayer(url) {
    const video = document.createElement("video");
    video.src = url;
    video.preload = "metadata";
    video.style.cssText = "width:100%;height:100%;object-fit:contain;";
    
    video.addEventListener("play", () => {
      isPaused = false;
      setOverlayText();
      el("playOverlay").style.display = "none";
    });
    
    video.addEventListener("pause", () => {
      isPaused = true;
      setOverlayText();
      el("playOverlay").style.display = "grid";
    });
    
    video.addEventListener("ended", () => {
      isPaused = false;
      setOverlayText();
      el("playOverlay").style.display = "grid";
    });
    
    video.addEventListener("loadedmetadata", () => {
      setStopEnabled(true);
    });
    
    el("playerHost").appendChild(video);
    htmlVideoEl = video;
    return video;
  }

  function createEmbedPlayer(url) {
    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.allow = "autoplay; fullscreen; encrypted-media";
    iframe.style.cssText = "width:100%;height:100%;border:0;";
    el("playerHost").appendChild(iframe);
    setStopEnabled(true);
    return iframe;
  }

  async function setVideo(videoUrl) {
    el("playOverlay").style.display = "grid";
    isPaused = false;
    setOverlayText();
    setStopEnabled(false);
    
    clearPlayer();
    
    const source = detectVideoSource(videoUrl);
    currentVideoSource = source;
    
    if (source.type === VideoType.NONE) {
      el("playerHost").innerHTML =
        `<div style="color:#fff;display:grid;place-items:center;width:100%;height:100%;font-weight:950;opacity:.9">Geen video</div>`;
      return;
    }
    
    switch (source.type) {
      case VideoType.YOUTUBE:
        await createYouTubePlayer(source.id);
        break;
      case VideoType.VIMEO:
        createVimeoPlayer(source.id);
        break;
      case VideoType.DIRECT:
        createDirectVideoPlayer(source.url);
        break;
      case VideoType.EMBED:
        createEmbedPlayer(source.url);
        break;
    }
  }

  async function playVideo() {
    const r = rounds[idx];
    const videoUrl = r.videoUrl || r.videoId || "";
    if (!videoUrl) return;
    
    const source = detectVideoSource(videoUrl);
    
    // Ensure correct player is loaded
    if (source.type !== currentVideoSource.type || 
        source.id !== currentVideoSource.id || 
        source.url !== currentVideoSource.url) {
      await setVideo(videoUrl);
    }
    
    switch (source.type) {
      case VideoType.YOUTUBE:
        if (ytPlayer && ytPlayerIsReady) {
          try {
            ytPlayer.playVideo();
            el("playOverlay").style.display = "none";
          } catch(_) {}
        }
        break;
        
      case VideoType.VIMEO:
        // Vimeo requires postMessage API - recreate with autoplay
        clearPlayer();
        const iframe = document.createElement("iframe");
        iframe.src = `https://player.vimeo.com/video/${source.id}?autoplay=1&title=0&byline=0&portrait=0`;
        iframe.allow = "autoplay; fullscreen";
        iframe.style.cssText = "width:100%;height:100%;border:0;";
        el("playerHost").appendChild(iframe);
        el("playOverlay").style.display = "none";
        break;
        
      case VideoType.DIRECT:
        if (htmlVideoEl) {
          htmlVideoEl.play();
        }
        break;
        
      case VideoType.EMBED:
        // Can't control generic embeds - just hide overlay
        el("playOverlay").style.display = "none";
        break;
    }
    
    setStopEnabled(true);
  }

  function stopVideo() {
    switch (currentVideoSource.type) {
      case VideoType.YOUTUBE:
        if (ytPlayer && ytPlayerIsReady) {
          try {
            ytPlayer.pauseVideo();
            ytPlayer.seekTo(0, true);
          } catch(_) {}
        }
        break;
        
      case VideoType.VIMEO:
        // Recreate without autoplay
        clearPlayer();
        createVimeoPlayer(currentVideoSource.id);
        break;
        
      case VideoType.DIRECT:
        if (htmlVideoEl) {
          htmlVideoEl.pause();
          htmlVideoEl.currentTime = 0;
        }
        break;
        
      case VideoType.EMBED:
        // Reload iframe to reset
        const url = currentVideoSource.url;
        clearPlayer();
        createEmbedPlayer(url);
        break;
    }
    
    isPaused = false;
    setOverlayText();
    el("playOverlay").style.display = "grid";
  }

  el("playBtn").addEventListener("click", playVideo);
  el("btnPlay").addEventListener("click", playVideo);
  el("btnStop").addEventListener("click", stopVideo);

  // --- Teacher panel read/write ---
  function readTeacher(){
    const map = {A:0,B:1,C:2,D:3};
    const cStr = String(el("tpCorrect").value||"").trim().toUpperCase();
    const c = (cStr in map) ? map[cStr] : 0;

    return {
      videoUrl: String(el("tpVideo").value||"").trim(),
      q: String(el("tpQuestion").value||"").trim(),
      a: [
        String(el("tpA").value||"").trim(),
        String(el("tpB").value||"").trim(),
        String(el("tpC").value||"").trim(),
        String(el("tpD").value||"").trim()
      ],
      c
    };
  }

  function writeTeacher(r){
    el("tpVideo").value = r.videoUrl || r.videoId || "";
    el("tpQuestion").value = r.q || "";
    el("tpA").value = r.a?.[0] || "";
    el("tpB").value = r.a?.[1] || "";
    el("tpC").value = r.a?.[2] || "";
    el("tpD").value = r.a?.[3] || "";
    el("tpCorrect").value = ["A","B","C","D"][clamp(r.c||0,0,3)];
  }

  function persistRounds(){
    localStorage.setItem(STORAGE, JSON.stringify(rounds));
    markTeacherSaving();
  }

  let autosaveTimer = null;
  function autosaveTeacherEdits(){
    if(!teacherUnlocked) return;
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      const r = readTeacher();

      rounds[idx] = {
        videoUrl: r.videoUrl || rounds[idx].videoUrl || "",
        q: r.q || "",
        a: r.a || ["","","",""],
        c: clamp(r.c||0,0,3)
      };
      persistRounds();

      el("question").textContent = rounds[idx].q || "‚Äî";
      renderAnswers();
      
      const newSource = detectVideoSource(r.videoUrl);
      if (r.videoUrl && (newSource.type !== currentVideoSource.type || 
          newSource.id !== currentVideoSource.id || 
          newSource.url !== currentVideoSource.url)) {
        setVideo(r.videoUrl);
      }
    }, 220);
    el("savePill").textContent = "Saving‚Ä¶";
  }

  ["tpVideo","tpQuestion","tpA","tpB","tpC","tpD","tpCorrect"].forEach(id=>{
    el(id).addEventListener("input", autosaveTeacherEdits);
    el(id).addEventListener("change", autosaveTeacherEdits);
  });

  el("saveRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    const r = readTeacher();
    if(!isValidRound(r)){
      alert("Vul minimaal: video URL + vraag + minstens 2 antwoorden.");
      return;
    }
    rounds[idx] = r;
    persistRounds();
    loadRound();
  });

  el("addRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    const r = readTeacher();
    if(!isValidRound(r)){
      alert("Vul minimaal: video URL + vraag + minstens 2 antwoorden.");
      return;
    }
    rounds.push(r);
    idx = rounds.length - 1;
    persistRounds();
    loadRound();
  });

  el("deleteRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    if(rounds.length <= 1){
      alert("Minimaal 1 ronde nodig.");
      return;
    }
    if(!confirm("Deze ronde verwijderen?")) return;
    rounds.splice(idx,1);
    idx = clamp(idx, 0, rounds.length - 1);
    persistRounds();
    loadRound();
  });

  // ============================
  // EXPORT / IMPORT FUNCTIONS
  // ============================
  
  el("exportDownload").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    const data = JSON.stringify(rounds, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const date = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `kennis-battle-rondes-${date}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  el("importShow").addEventListener("click", () => {
    el("importArea").classList.toggle("show");
  });

  el("importCancel").addEventListener("click", () => {
    el("importArea").classList.remove("show");
    el("importData").value = "";
  });

  el("importFileBtn").addEventListener("click", () => {
    el("importFileInput").click();
  });

  el("importFileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      el("importData").value = ev.target.result;
    };
    reader.readAsText(file);
    e.target.value = "";
  });

  function parseImportData(){
    const raw = el("importData").value.trim();
    if(!raw){
      alert("Plak eerst data of kies een bestand.");
      return null;
    }
    
    let parsed;
    try{
      parsed = JSON.parse(raw);
    }catch(e){
      alert("Ongeldige JSON data. Controleer het format.");
      return null;
    }
    
    if(!Array.isArray(parsed)){
      alert("Data moet een array van rondes zijn.");
      return null;
    }
    
    const validRounds = [];
    for(let i = 0; i < parsed.length; i++){
      const r = parsed[i];
      if(!r || typeof r !== "object"){
        alert(`Ronde ${i+1} is ongeldig.`);
        return null;
      }
      
      // Normalize the round - support both old and new format
      const videoUrl = r.videoUrl || r.videoId || r.video || "";
      const normalized = {
        videoUrl: videoUrl,
        q: String(r.q || r.question || "").trim(),
        a: Array.isArray(r.a) ? r.a.map(x => String(x||"").trim()) : 
           Array.isArray(r.answers) ? r.answers.map(x => String(x||"").trim()) :
           ["","","",""],
        c: typeof r.c === "number" ? clamp(r.c, 0, 3) :
           typeof r.correct === "number" ? clamp(r.correct, 0, 3) : 0
      };
      
      while(normalized.a.length < 4) normalized.a.push("");
      normalized.a = normalized.a.slice(0,4);
      
      if(!isValidRound(normalized)){
        alert(`Ronde ${i+1} mist video URL, vraag of minimaal 2 antwoorden.`);
        return null;
      }
      
      validRounds.push(normalized);
    }
    
    if(validRounds.length === 0){
      alert("Geen geldige rondes gevonden.");
      return null;
    }
    
    return validRounds;
  }

  el("importReplace").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    
    const newRounds = parseImportData();
    if(!newRounds) return;
    
    if(!confirm(`${newRounds.length} ronde(s) gevonden. Alle bestaande rondes vervangen?`)){
      return;
    }
    
    rounds = newRounds;
    idx = 0;
    persistRounds();
    loadRound();
    
    el("importArea").classList.remove("show");
    el("importData").value = "";
    alert(`${newRounds.length} ronde(s) ge√Ømporteerd!`);
  });

  el("importAdd").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    
    const newRounds = parseImportData();
    if(!newRounds) return;
    
    if(!confirm(`${newRounds.length} ronde(s) toevoegen aan de bestaande ${rounds.length} ronde(s)?`)){
      return;
    }
    
    rounds = rounds.concat(newRounds);
    persistRounds();
    loadRound();
    
    el("importArea").classList.remove("show");
    el("importData").value = "";
    alert(`${newRounds.length} ronde(s) toegevoegd! Totaal: ${rounds.length} rondes.`);
  });

  // ============================
  // SERVER RELOAD
  // ============================
  
  function updateServerStatus() {
    const status = el("serverStatus");
    if (!QUESTIONS_URL) {
      status.textContent = "Geen URL ingesteld";
    } else {
      status.textContent = "URL: " + QUESTIONS_URL.slice(0, 50) + (QUESTIONS_URL.length > 50 ? "..." : "");
    }
  }
  
  el("reloadServer").addEventListener("click", async () => {
    if (!QUESTIONS_URL) {
      alert("Geen URL ingesteld. Pas QUESTIONS_URL aan in de code.");
      return;
    }
    
    el("reloadServer").disabled = true;
    el("reloadServer").textContent = "Laden...";
    
    const serverRounds = await fetchRoundsFromServer();
    
    if (serverRounds) {
      rounds = serverRounds;
      localStorage.setItem(STORAGE, JSON.stringify(rounds));
      idx = 0;
      loadRound();
      alert(`${rounds.length} ronde(s) geladen van server!`);
    } else {
      alert("Kon niet laden van server. Controleer de URL en probeer opnieuw.");
    }
    
    el("reloadServer").disabled = false;
    el("reloadServer").textContent = "üîÑ Herlaad van server";
  });

  // ============================
  // END EXPORT / IMPORT
  // ============================

  function loadRound(){
    idx = clamp(idx, 0, rounds.length - 1);
    const r = rounds[idx];

    el("roundInfo").textContent = `Ronde ${idx+1}/${rounds.length}`;
    el("tpRoundInfo").textContent = `${idx+1}/${rounds.length}`;
    setVideo(r.videoUrl || r.videoId || "");

    el("prev").disabled = (idx === 0);
    el("next").disabled = (idx === rounds.length - 1);
    el("nextQuestion").disabled = (idx === rounds.length - 1);
    el("moveUp").disabled = (idx === rounds.length - 1);
    el("moveDown").disabled = (idx === 0);

    writeTeacher(r);
    resetRoundUI();
  }

  function awardPoint(t){
    if(t==="A") scoreA++; else scoreB++;
    el("scoreA").textContent = String(scoreA);
    el("scoreB").textContent = String(scoreB);
    localStorage.setItem(SCORE_KEY, JSON.stringify({a:scoreA, b:scoreB}));
  }

  function choose(n){
    if(answered) return;

    const r = rounds[idx];
    answered = true;
    renderAnswers(n);
    
    if(idx >= rounds.length - 1){
      setTimeout(showWinner, 1000);
    }
  }

  function showWinner(){
    const nameA = el("nameAInput").value.trim() || "Team A";
    const nameB = el("nameBInput").value.trim() || "Team B";
    
    let title, name;
    if(scoreA > scoreB){
      title = "Winnaar!";
      name = nameA;
    } else if(scoreB > scoreA){
      title = "Winnaar!";
      name = nameB;
    } else {
      title = "Gelijkspel!";
      name = nameA + " & " + nameB;
    }
    
    el("winnerTitle").textContent = title;
    el("winnerName").textContent = name;
    el("winnerScore").textContent = scoreA + " - " + scoreB;
    el("winnerModal").classList.add("show");
  }

  el("closeWinner").addEventListener("click", () => {
    el("winnerModal").classList.remove("show");
  });

  el("prev").addEventListener("click", ()=>{ idx = Math.max(0, idx-1); loadRound(); });
  el("next").addEventListener("click", ()=>{ idx = Math.min(rounds.length-1, idx+1); loadRound(); });

  el("moveUp").addEventListener("click", ()=>{
    if(!teacherUnlocked || idx >= rounds.length-1) return;
    const temp = rounds[idx];
    rounds[idx] = rounds[idx+1];
    rounds[idx+1] = temp;
    idx++;
    persistRounds();
    loadRound();
  });

  el("moveDown").addEventListener("click", ()=>{
    if(!teacherUnlocked || idx <= 0) return;
    const temp = rounds[idx];
    rounds[idx] = rounds[idx-1];
    rounds[idx-1] = temp;
    idx--;
    persistRounds();
    loadRound();
  });

  el("nextQuestion").addEventListener("click", ()=>{
    if(idx < rounds.length - 1){
      idx++;
      loadRound();
    }
  });

  el("resetScore").addEventListener("click", ()=>{
    if(!confirm("Spel volledig resetten?")) return;
    scoreA = 0; scoreB = 0;
    el("scoreA").textContent = "0";
    el("scoreB").textContent = "0";
    localStorage.setItem(SCORE_KEY, JSON.stringify({a:scoreA, b:scoreB}));
    idx = 0;
    loadRound();
  });

  window.addEventListener("keydown", (e)=>{
    const tag = document.activeElement?.tagName?.toLowerCase();
    if(tag === "input" || tag === "textarea") return;
    
    if(!answered){
      if(e.key==="1") choose(0);
      if(e.key==="2") choose(1);
      if(e.key==="3") choose(2);
      if(e.key==="4") choose(3);
    }
    if(e.key.toLowerCase()==="x") stopVideo();
    if(e.key.toLowerCase()==="p") playVideo();
  });

  // Initialize app
  async function init() {
    await initRounds();
    setLockUI();
    updateServerStatus();
    loadRound();
  }
  
  init();
})();
</script>
</body>
</html>
