<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kennis Battle</title>

<style>
:root{
  --A:#4f7cff;
  --B:#ef4444;
  --ink:#111;
  --muted:#6b7280;
  --border:rgba(0,0,0,.12);
  --shadow:0 12px 34px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#fff;
  color:var(--ink);
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  overflow:hidden;
}

.topTitle{
  position:fixed;
  top:14px;
  left:50%;
  transform:translateX(-50%);
  font-size:22px;
  font-weight:950;
  letter-spacing:.2px;
  z-index:3000;
  pointer-events:none;
}

.teacherBtn{
  position:fixed;
  top:10px;
  right:10px;
  z-index:3500;
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#111;
  color:#fff;
  font-weight:950;
  cursor:pointer;
  font-size:13px;
}

.tournamentBtn{
  position:fixed;
  top:10px;
  right:90px;
  z-index:3500;
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  color:#111;
  font-weight:950;
  cursor:pointer;
  font-size:13px;
}

.wrap{
  max-width:1100px;
  height:100vh;
  margin:0 auto;
  padding:52px 10px 10px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:10px;
}

.topRow{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:0;
}

.teamCard{
  border:1px solid rgba(0,0,0,.12);
  background:#fff;
  padding:16px 20px;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:8px;
  min-width:280px;
  transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
}

.teamCard .score{
  font-size:32px;
  font-weight:1000;
  line-height:1;
  color:#111;
}

.nameRow{
  display:flex;
  align-items:center;
  gap:8px;
  width:100%;
}

.keyLabel{
  font-size:14px;
  font-weight:900;
  color:#999;
  min-width:16px;
  text-align:center;
}

.nameInput{
  flex:1;
  text-align:center;
  font-weight:600;
  font-size:16px;
  border:1px solid rgba(0,0,0,.10);
  border-radius:10px;
  padding:10px 14px;
  outline:none;
  user-select:text;
  background:#fff;
  color:#666;
  transition: border-color .15s ease;
}
.nameInput::placeholder{ color:#999; }
.nameInput:focus{ border-color:rgba(0,0,0,.25); }

/* Active states - red left, green right */
.teamCard.A.active{
  background:rgba(239,68,68,.1);
  border-color:rgba(239,68,68,.5);
  box-shadow:0 0 0 3px rgba(239,68,68,.1);
}
.teamCard.A.active .score{ color:#dc2626; }

.teamCard.B.active{
  background:rgba(34,197,94,.1);
  border-color:rgba(34,197,94,.5);
  box-shadow:0 0 0 3px rgba(34,197,94,.1);
}
.teamCard.B.active .score{ color:#16a34a; }

.main{
  display:grid;
  grid-template-rows:auto auto auto;
  gap:10px;
  min-height:0;
  align-items:stretch;
}

.videoStage{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:8px;
  min-height:0;
}

.videoBox{
  width:min(640px, 100%);
  aspect-ratio:16/9;
  max-height:44vh;
  border-radius:16px;
  overflow:hidden;
  background:#000;
  box-shadow:var(--shadow);
  position:relative;
}
#playerHost{ position:absolute; inset:0; }
.videoBox iframe{
  width:100%;
  height:100%;
  border:0;
  display:block;
  pointer-events:none;
}

.playOverlay{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  background:linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.28));
  z-index:5;
}
.playBtn{
  border:0;
  cursor:pointer;
  padding:14px 18px;
  border-radius:16px;
  font-weight:1000;
  font-size:16px;
  background:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.25);
  display:flex;
  align-items:center;
  gap:10px;
}
.playIcon{
  width:0;height:0;
  border-top:9px solid transparent;
  border-bottom:9px solid transparent;
  border-left:14px solid #111;
}

.videoControls{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.ctrlBtn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:950;
  cursor:pointer;
  font-size:13px;
}
.ctrlBtn.primary{ background:#111; color:#fff; border-color:transparent}
.ctrlBtn:disabled{ opacity:.45; cursor:not-allowed; }

.qa{
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:8px;
  min-height:0;
  background:#fff;
}
.question{
  text-align:center;
  font-size:16px;
  font-weight:1000;
  line-height:1.2;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px 4px;
  border:1px solid rgba(0,0,0,.06);
  border-radius:12px;
  min-height:46px;
}

.answers{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.col{
  display:grid;
  grid-template-rows:1fr 1fr;
  gap:8px;
  align-items:stretch;
}
.answer{
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:950;
  cursor:pointer;
  background:#fff;
  padding:10px 12px 10px 14px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  text-align:left;
  line-height:1.15;
  min-height:60px;
  font-size:14px;
}
.answer:hover{ background:#f9fafb; }
.answer.disabled{ opacity:.45; pointer-events:none; }
.answer.correct{ background:#dcfce7; border-color:rgba(22,163,74,.55); }
.answer.wrong{ background:#fee2e2; border-color:rgba(220,38,38,.55); }

.bottomControls{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.btn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  font-size:13px;
}

/* Teacher panel */
.teacherPanel{
  position:fixed;
  right:10px;
  top:50px;
  bottom:10px;
  width:320px;
  max-height:calc(100vh - 60px);
  overflow-y:auto;
  background:#fff;
  border:1px solid rgba(0,0,0,.15);
  border-radius:16px;
  padding:12px;
  box-shadow:0 12px 34px rgba(0,0,0,.12);
  z-index:3600;
  display:none;
}
.teacherPanel.open{ display:block; }

.tpTop{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.tpTop .title{font-weight:1000;font-size:13px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.lockPill{
  font-size:10px;
  font-weight:1000;
  padding:3px 6px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f8fafc;
  color:#111;
}
.savePill{
  font-size:11px;
  font-weight:1000;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#fff;
  color:#111;
}
.tpTop .close{border:1px solid var(--border);background:#fff;border-radius:8px;padding:5px 8px;font-weight:950;cursor:pointer;font-size:13px}

.tpNav{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-bottom:12px;
  padding:8px;
  background:#f5f5f5;
  border-radius:10px;
}
.tpRoundInfo{
  font-weight:1000;
  font-size:14px;
  min-width:40px;
  text-align:center;
}
.tpNavSpacer{
  flex:1;
}
.btnSmall{
  padding:6px 10px;
  font-size:12px;
}

label{display:block;font-size:11px;font-weight:900;color:var(--muted);margin:7px 0 5px}
input.tp,textarea.tp{
  width:100%;
  padding:9px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  font:inherit;
  user-select:text;
  outline:none;
  font-size:13px;
}
textarea.tp{min-height:66px;resize:vertical}
.tpGrid{display:grid;grid-template-columns:1fr;gap:9px}
.tpActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:9px}
.tpActions .btn{flex:1;min-width:80px;text-align:center}
.btnPrimary{ background:#111; color:#fff; border-color:transparent; }
.smallHint{font-size:11px;color:var(--muted);margin-top:6px}

/* Export/Import section */
.exportSection{
  margin-top:14px;
  padding-top:14px;
  border-top:1px solid var(--border);
}
.exportSection .sectionTitle{
  font-weight:1000;
  font-size:12px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}
.exportBtns{
  display:flex;
  gap:8px;
  flex-direction:column;
  margin-bottom:10px;
}
.importArea{
  display:none;
  margin-top:10px;
}
.importArea.show{ display:block; }
.importArea textarea{
  width:100%;
  min-height:80px;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  font-family:monospace;
  font-size:12px;
  resize:vertical;
}
.importActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.importActions .btn{
  flex:1;
  min-width:80px;
  text-align:center;
}

.footer{
  position:fixed;
  bottom:10px;
  right:14px;
  font-size:11px;
  color:var(--muted);
  z-index:2000;
}

.winnerModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:5000;
  place-items:center;
}
.winnerModal.show{
  display:grid;
}
.winnerBox{
  background:#fff;
  border-radius:20px;
  padding:32px 48px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.winnerTitle{
  font-size:24px;
  font-weight:900;
  margin-bottom:8px;
}
.winnerName{
  font-size:36px;
  font-weight:1000;
  margin-bottom:8px;
}
.winnerScore{
  font-size:20px;
  font-weight:700;
  color:#666;
  margin-bottom:20px;
}
.winnerModal .btn{
  padding:12px 24px;
  font-size:15px;
}

/* Tournament panel */
.tournamentPanel{
  position:fixed;
  left:10px;
  top:50px;
  bottom:10px;
  width:340px;
  max-height:calc(100vh - 60px);
  overflow-y:auto;
  background:#fff;
  border:1px solid rgba(0,0,0,.15);
  border-radius:16px;
  padding:12px;
  box-shadow:0 12px 34px rgba(0,0,0,.12);
  z-index:3600;
  display:none;
}
.tournamentPanel.open{ display:block; }

.currentMatch{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  padding:16px;
  background:#f5f5f5;
  border-radius:12px;
  margin:12px 0;
}
.matchPlayer{
  flex:1;
  text-align:center;
  font-weight:900;
  font-size:16px;
  padding:12px;
  background:#fff;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.1);
}
.matchVs{
  font-weight:700;
  color:#999;
  font-size:14px;
}
.matchActions{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-bottom:16px;
}
.matchActions .btn{
  flex:1;
}

.bracketInfo{
  text-align:center;
  font-weight:900;
  font-size:14px;
  color:#666;
  margin-bottom:8px;
}

.bracketStandings{
  margin-top:16px;
  border-top:1px solid rgba(0,0,0,.1);
  padding-top:12px;
}
.standingsTitle{
  font-weight:900;
  font-size:12px;
  color:#666;
  margin-bottom:8px;
}
.standingsList{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.standingItem{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  background:#f9f9f9;
  border-radius:8px;
  font-size:13px;
}
.standingItem.eliminated{
  opacity:.5;
  text-decoration:line-through;
}
.standingItem.winner{
  background:#dcfce7;
  font-weight:900;
}
.standingItem .wins{
  margin-left:auto;
  font-weight:700;
  color:#666;
  font-size:11px;
}

.finalWinnerTitle{
  text-align:center;
  font-size:20px;
  font-weight:900;
  color:#b8860b;
  margin-bottom:8px;
}
.finalWinnerName{
  text-align:center;
  font-size:32px;
  font-weight:1000;
  margin-bottom:16px;
  color:#111;
}

/* Hidden file input */
#importFileInput{
  display:none;
}
</style>
</head>

<body>

<div class="topTitle">Kennis Battle</div>
<button class="teacherBtn" id="teacherBtn" type="button">Teacher</button>
<button class="tournamentBtn" id="tournamentBtn" type="button">Toernooi</button>

<div class="wrap" id="app">
  <div class="topRow">
    <div class="teamCard A" id="cardA">
      <div class="score" id="scoreA">0</div>
      <div class="nameRow">
        <span class="keyLabel">A</span>
        <input class="nameInput" id="nameAInput" placeholder="Naam" value="" maxlength="18" aria-label="Naam team A">
      </div>
    </div>

    <div class="teamCard B" id="cardB">
      <div class="score" id="scoreB">0</div>
      <div class="nameRow">
        <input class="nameInput" id="nameBInput" placeholder="Naam" value="" maxlength="18" aria-label="Naam team B">
        <span class="keyLabel">L</span>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="videoStage">
      <div class="videoBox">
        <div id="playerHost"></div>

        <div class="playOverlay" id="playOverlay">
          <button class="playBtn" id="playBtn" type="button">
            <span class="playIcon"></span>
            <span id="playText">Start video</span>
          </button>
        </div>
      </div>

      <div class="videoControls">
        <button class="ctrlBtn primary" id="btnPlay" type="button">Play</button>
        <button class="ctrlBtn" id="btnStop" type="button" disabled>Stop</button>
      </div>
    </div>

    <div class="qa">
      <div class="question" id="question">‚Äî</div>
      <div class="answers">
        <div class="col" id="colLeft"></div>
        <div class="col" id="colRight"></div>
      </div>
    </div>

    <div class="bottomControls">
      <div id="roundInfo">Ronde 1/1</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="resetScore" type="button">Reset score</button>
      </div>
    </div>
  </div>
</div>

<div class="teacherPanel" id="teacherPanel" aria-hidden="true">
  <div class="tpTop">
    <div class="title">
      Teacher
      <span class="lockPill" id="lockPill">locked</span>
      <span class="savePill" id="savePill">Saved ‚úì</span>
    </div>
    <button class="close" id="tpClose" type="button">‚úï</button>
  </div>

  <div class="tpNav">
    <button class="btn" id="prev" type="button">‚óÄ</button>
    <span class="tpRoundInfo" id="tpRoundInfo">1/1</span>
    <button class="btn" id="next" type="button">‚ñ∂</button>
    <span class="tpNavSpacer"></span>
    <button class="btn btnSmall" id="moveUp" type="button" title="Omhoog">‚Üë</button>
    <button class="btn btnSmall" id="moveDown" type="button" title="Omlaag">‚Üì</button>
  </div>

  <div class="tpGrid">
    <div>
      <label>YouTube link of ID</label>
      <input class="tp" id="tpVideo" placeholder="https://youtu.be/QV4tivE8vYo (of: QV4tivE8vYo)">
    </div>

    <div>
      <label>Vraag</label>
      <textarea class="tp" id="tpQuestion" placeholder="Typ je vraag..."></textarea>
    </div>

    <div><label>Antwoord A</label><input class="tp" id="tpA"></div>
    <div><label>Antwoord B</label><input class="tp" id="tpB"></div>
    <div><label>Antwoord C</label><input class="tp" id="tpC"></div>
    <div><label>Antwoord D</label><input class="tp" id="tpD"></div>

    <div>
      <label>Correct (A/B/C/D)</label>
      <input class="tp" id="tpCorrect" placeholder="A">
    </div>
  </div>

  <div class="tpActions">
    <button class="btn btnPrimary" id="saveRound" type="button">Save</button>
    <button class="btn" id="addRound" type="button">Add</button>
    <button class="btn" id="deleteRound" type="button">Delete</button>
  </div>

  <!-- Export/Import Section -->
  <div class="exportSection">
    <div class="sectionTitle">
      Delen & Importeren
    </div>
    <div class="exportBtns">
      <button class="btn" id="exportDownload" type="button">Download als bestand</button>
      <button class="btn" id="importShow" type="button">Importeer rondes</button>
    </div>
    
    <div class="importArea" id="importArea">
      <label>Plak data of kies bestand:</label>
      <div style="margin-bottom:8px">
        <button class="btn" id="importFileBtn" type="button">Kies bestand</button>
        <input type="file" id="importFileInput" accept=".json,.txt">
      </div>
      <textarea id="importData" placeholder='Plak JSON data...'></textarea>
      <div class="importActions">
        <button class="btn btnPrimary" id="importReplace" type="button">Vervang</button>
        <button class="btn btnPrimary" id="importAdd" type="button">Toevoegen</button>
        <button class="btn" id="importCancel" type="button">Annuleer</button>
      </div>
    </div>
  </div>
</div>

<div class="tournamentPanel" id="tournamentPanel">
  <div class="tpTop">
    <div class="title">Toernooi</div>
    <button class="close" id="tournamentClose" type="button">‚úï</button>
  </div>

  <div class="tournamentSetup" id="tournamentSetup">
    <label>Spelers (√©√©n per regel)</label>
    <textarea class="tp" id="playerList" placeholder="Jan&#10;Piet&#10;Klaas&#10;Marie"></textarea>
    <div class="tpActions">
      <button class="btn btnPrimary" id="startTournament" type="button">Start Toernooi</button>
    </div>
  </div>

  <div class="tournamentBracket" id="tournamentBracket" style="display:none">
    <div class="bracketInfo" id="bracketInfo">Ronde 1</div>
    <div class="currentMatch" id="currentMatch">
      <div class="matchPlayer" id="matchPlayerA">-</div>
      <div class="matchVs">vs</div>
      <div class="matchPlayer" id="matchPlayerB">-</div>
    </div>
    <div class="matchActions">
      <button class="btn" id="winnerA" type="button">‚Üê Wint</button>
      <button class="btn" id="winnerB" type="button">Wint ‚Üí</button>
    </div>
    <button class="btn btnPrimary" id="loadMatch" type="button" style="width:100%;margin-bottom:12px">Laad in spel</button>
    <div class="bracketStandings" id="bracketStandings"></div>
    <div class="tpActions">
      <button class="btn" id="resetTournament" type="button">Reset Toernooi</button>
    </div>
  </div>

  <div class="tournamentWinner" id="tournamentWinner" style="display:none">
    <div class="finalWinnerTitle">üèÜ Kampioen! üèÜ</div>
    <div class="finalWinnerName" id="finalWinnerName">-</div>
    <div class="tpActions">
      <button class="btn btnPrimary" id="newTournament" type="button">Nieuw Toernooi</button>
    </div>
  </div>
</div>

<div class="footer">Muziek met meester Luis</div>

<div class="winnerModal" id="winnerModal">
  <div class="winnerBox">
    <div class="winnerTitle" id="winnerTitle">üèÜ Winnaar!</div>
    <div class="winnerName" id="winnerName">Team A</div>
    <div class="winnerScore" id="winnerScore">5 - 3</div>
    <button class="btn btnPrimary" id="closeWinner" type="button">Sluiten</button>
  </div>
</div>

<script>
(() => {
  // =========================
  // Teacher password (local)
  // =========================
  const TEACHER_PASSWORD = "muziek"; // üëà verander dit
  let teacherUnlocked = false;

  const STORAGE = "kennis_battle_rounds_v8";
  const SCORE_KEY = "kennis_battle_scores_v8";
  const NAMES_KEY = "kennis_battle_names_v8";

  const el = id => document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  // -------------------------
  // save pill
  // -------------------------
  let teacherSaveTimer = null;
  function markTeacherSaving(){
    el("savePill").textContent = "Saving‚Ä¶";
    clearTimeout(teacherSaveTimer);
    teacherSaveTimer = setTimeout(() => {
      el("savePill").textContent = "Saved ‚úì";
    }, 350);
  }

  function setLockUI(){
    el("lockPill").textContent = teacherUnlocked ? "unlocked" : "locked";
    el("teacherPanel").setAttribute("aria-hidden", teacherUnlocked ? "false" : "true");
  }

  // --- Teacher toggle with password ---
  el("teacherBtn").addEventListener("click", () => {
    if(!teacherUnlocked){
      const pw = prompt("Teacher wachtwoord:");
      if(pw !== TEACHER_PASSWORD){
        alert("Onjuist wachtwoord");
        return;
      }
      teacherUnlocked = true;
      setLockUI();
    }
    el("teacherPanel").classList.toggle("open");
  });
  el("tpClose").addEventListener("click", () => el("teacherPanel").classList.remove("open"));

  // --- Helpers ---
  function ytId(v){
    if(!v) return "";
    v = String(v).trim();
    if(/^[\w-]{6,}$/.test(v) && !v.includes("http")) return v;
    const m = v.match(/[?&]v=([\w-]+)/) || v.match(/youtu\.be\/([\w-]+)/) || v.match(/youtube\.com\/embed\/([\w-]+)/);
    return m ? m[1] : "";
  }
  function isValidRound(r){
    if(!r.videoId) return false;
    if(!r.q) return false;
    if(!Array.isArray(r.a) || r.a.filter(Boolean).length < 2) return false;
    return true;
  }
  function cleanName(s){ return String(s||"").trim().slice(0,18); }

  function saveNames(){
    localStorage.setItem(NAMES_KEY, JSON.stringify({
      a: cleanName(el("nameAInput").value),
      b: cleanName(el("nameBInput").value),
    }));
  }
  el("nameAInput").addEventListener("input", saveNames);
  el("nameBInput").addEventListener("input", saveNames);

  // --- Load rounds ---
  let rounds;
  try{ rounds = JSON.parse(localStorage.getItem(STORAGE)); }catch(_){ rounds=null; }
  if(!Array.isArray(rounds) || !rounds.length){
    rounds = [{
      videoId:"QV4tivE8vYo",
      q:"Welk instrument hoor je?",
      a:["Trompet","Trombone","Hoorn","Tuba"],
      c:0
    }];
    localStorage.setItem(STORAGE, JSON.stringify(rounds));
  }

  // --- Load names ---
  try{
    const n = JSON.parse(localStorage.getItem(NAMES_KEY) || "{}");
    if(typeof n.a === "string") el("nameAInput").value = cleanName(n.a);
    if(typeof n.b === "string") el("nameBInput").value = cleanName(n.b);
  }catch(_){}

  // --- Scores ---
  let scoreA = 0, scoreB = 0;
  try{
    const s = JSON.parse(localStorage.getItem(SCORE_KEY) || "{}");
    if(typeof s.a === "number") scoreA = s.a;
    if(typeof s.b === "number") scoreB = s.b;
  }catch(_){}
  el("scoreA").textContent = String(scoreA);
  el("scoreB").textContent = String(scoreB);

  // --- Turn logic ---
  let idx = 0;
  let buzzedTeam = null; // null = waiting for buzz, "A" or "B" = team that buzzed
  let answered = false;

  function setActiveTeam(t){
    el("cardA").classList.toggle("active", t==="A");
    el("cardB").classList.toggle("active", t==="B");
  }

  function renderAnswers(feedbackIndex=null){
    const r = rounds[idx];
    const letters = ["A","B","C","D"];
    const colL = el("colLeft");
    const colR = el("colRight");
    colL.innerHTML = "";
    colR.innerHTML = "";

    function makeBtn(n){
      const d = document.createElement("div");
      d.className = "answer";
      d.textContent = `${letters[n]}: ${(r.a && r.a[n]) ? r.a[n] : "‚Äî"}`;
      d.addEventListener("click", ()=>choose(n));

      // Disable if no one buzzed yet or already answered
      if(!buzzedTeam || answered){
        d.classList.add("disabled");
      }
      if(answered){
        if(n === r.c) d.classList.add("correct");
        if(feedbackIndex !== null && n === feedbackIndex && n !== r.c) d.classList.add("wrong");
      }
      return d;
    }

    colL.appendChild(makeBtn(0)); // A
    colL.appendChild(makeBtn(2)); // C
    colR.appendChild(makeBtn(1)); // B
    colR.appendChild(makeBtn(3)); // D
  }

  function resetRoundUI(){
    answered = false;
    buzzedTeam = null;
    setActiveTeam(null);
    renderAnswers();
    el("question").textContent = rounds[idx].q || "‚Äî";
  }

  function buzzIn(team){
    if(buzzedTeam || answered) return; // Already buzzed or answered
    buzzedTeam = team;
    setActiveTeam(team);
    renderAnswers();
  }

  // --- YouTube API ---
  let ytReady = false;
  let player = null;
  let playerIsReady = false;
  let currentVideoId = "";
  let isPaused = false;

  function setStopEnabled(on){ el("btnStop").disabled = !on; }
  function setOverlayText(){ el("playText").textContent = isPaused ? "Verder kijken" : "Start video"; }

  function loadYTApi(){
    return new Promise((resolve) => {
      if(ytReady && window.YT && window.YT.Player) return resolve();
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
      window.onYouTubeIframeAPIReady = () => { ytReady = true; resolve(); };
    });
  }

  async function ensurePlayer(videoId){
    await loadYTApi();
    if(player && currentVideoId === videoId) return;

    if(player && player.destroy){
      try{ player.destroy(); }catch(_){}
    }

    currentVideoId = videoId;
    playerIsReady = false;
    setStopEnabled(false);
    isPaused = false;
    setOverlayText();

    player = new YT.Player("playerHost", {
      videoId,
      playerVars: {
        controls: 0,
        fs: 0,
        rel: 0,
        modestbranding: 1,
        iv_load_policy: 3,
        disablekb: 1,
        playsinline: 1,
        autoplay: 0
      },
      events: {
        onReady: () => { playerIsReady = true; setStopEnabled(true); },
        onStateChange: (e) => {
          if(!window.YT) return;
          if(e.data === YT.PlayerState.PAUSED){ isPaused = true; setOverlayText(); el("playOverlay").style.display = "grid"; }
          if(e.data === YT.PlayerState.PLAYING){
            isPaused = false; setOverlayText();
            el("playOverlay").style.display = "none";
          }
          if(e.data === YT.PlayerState.ENDED){
            isPaused = false; setOverlayText();
            el("playOverlay").style.display = "grid";
          }
        }
      }
    });
  }

  async function setVideo(videoId){
    el("playOverlay").style.display = "grid";
    isPaused = false;
    setOverlayText();

    el("playerHost").innerHTML = "";
    if(!videoId){
      el("playerHost").innerHTML =
        `<div style="color:#fff;display:grid;place-items:center;width:100%;height:100%;font-weight:950;opacity:.9">Geen video</div>`;
      setStopEnabled(false);
      return;
    }
    await ensurePlayer(videoId);
  }

  async function playVideo(){
    const id = rounds[idx]?.videoId || "";
    if(!id) return;
    await ensurePlayer(id);
    try{
      player.playVideo();
      el("playOverlay").style.display = "none";
      setStopEnabled(true);
    }catch(_){}
  }

  function stopVideo(){
    if(!player || !playerIsReady) return;
    try{
      player.pauseVideo();
      player.seekTo(0, true);
    }catch(_){}
    isPaused = false;
    setOverlayText();
    el("playOverlay").style.display = "grid";
  }

  el("playBtn").addEventListener("click", playVideo);
  el("btnPlay").addEventListener("click", playVideo);
  el("btnStop").addEventListener("click", stopVideo);

  // --- Teacher panel read/write ---
  function readTeacher(){
    const map = {A:0,B:1,C:2,D:3};
    const cStr = String(el("tpCorrect").value||"").trim().toUpperCase();
    const c = (cStr in map) ? map[cStr] : 0;

    return {
      videoId: ytId(el("tpVideo").value),
      q: String(el("tpQuestion").value||"").trim(),
      a: [
        String(el("tpA").value||"").trim(),
        String(el("tpB").value||"").trim(),
        String(el("tpC").value||"").trim(),
        String(el("tpD").value||"").trim()
      ],
      c
    };
  }

  function writeTeacher(r){
    el("tpVideo").value = r.videoId || "";
    el("tpQuestion").value = r.q || "";
    el("tpA").value = r.a?.[0] || "";
    el("tpB").value = r.a?.[1] || "";
    el("tpC").value = r.a?.[2] || "";
    el("tpD").value = r.a?.[3] || "";
    el("tpCorrect").value = ["A","B","C","D"][clamp(r.c||0,0,3)];
  }

  function persistRounds(){
    localStorage.setItem(STORAGE, JSON.stringify(rounds));
    markTeacherSaving();
  }

  let autosaveTimer = null;
  function autosaveTeacherEdits(){
    if(!teacherUnlocked) return;
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      const r = readTeacher();

      rounds[idx] = {
        videoId: r.videoId || rounds[idx].videoId || "",
        q: r.q || "",
        a: r.a || ["","","",""],
        c: clamp(r.c||0,0,3)
      };
      persistRounds();

      el("question").textContent = rounds[idx].q || "‚Äî";
      renderAnswers();
      if(r.videoId && r.videoId !== currentVideoId) setVideo(r.videoId);
    }, 220);
    el("savePill").textContent = "Saving‚Ä¶";
  }

  ["tpVideo","tpQuestion","tpA","tpB","tpC","tpD","tpCorrect"].forEach(id=>{
    el(id).addEventListener("input", autosaveTeacherEdits);
    el(id).addEventListener("change", autosaveTeacherEdits);
  });

  el("saveRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    const r = readTeacher();
    if(!isValidRound(r)){
      alert("Vul minimaal: video + vraag + minstens 2 antwoorden.");
      return;
    }
    rounds[idx] = r;
    persistRounds();
    loadRound();
  });

  el("addRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    const r = readTeacher();
    if(!isValidRound(r)){
      alert("Vul minimaal: video + vraag + minstens 2 antwoorden.");
      return;
    }
    rounds.push(r);
    idx = rounds.length - 1;
    persistRounds();
    loadRound();
  });

  el("deleteRound").addEventListener("click", ()=>{
    if(!teacherUnlocked) return;
    if(rounds.length <= 1){
      alert("Minimaal 1 ronde nodig.");
      return;
    }
    if(!confirm("Deze ronde verwijderen?")) return;
    rounds.splice(idx,1);
    idx = clamp(idx, 0, rounds.length - 1);
    persistRounds();
    loadRound();
  });

  // ============================
  // EXPORT / IMPORT FUNCTIONS
  // ============================
  
  // Export: Download as file
  el("exportDownload").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    const data = JSON.stringify(rounds, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const date = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `kennis-battle-rondes-${date}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Show/hide import area
  el("importShow").addEventListener("click", () => {
    el("importArea").classList.toggle("show");
  });

  el("importCancel").addEventListener("click", () => {
    el("importArea").classList.remove("show");
    el("importData").value = "";
  });

  // File input handler
  el("importFileBtn").addEventListener("click", () => {
    el("importFileInput").click();
  });

  el("importFileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      el("importData").value = ev.target.result;
    };
    reader.readAsText(file);
    e.target.value = ""; // Reset for re-selecting same file
  });

  // Parse and validate import data
  function parseImportData(){
    const raw = el("importData").value.trim();
    if(!raw){
      alert("Plak eerst data of kies een bestand.");
      return null;
    }
    
    let parsed;
    try{
      parsed = JSON.parse(raw);
    }catch(e){
      alert("Ongeldige JSON data. Controleer het format.");
      return null;
    }
    
    if(!Array.isArray(parsed)){
      alert("Data moet een array van rondes zijn.");
      return null;
    }
    
    // Validate each round
    const validRounds = [];
    for(let i = 0; i < parsed.length; i++){
      const r = parsed[i];
      if(!r || typeof r !== "object"){
        alert(`Ronde ${i+1} is ongeldig.`);
        return null;
      }
      
      // Normalize the round
      const normalized = {
        videoId: ytId(r.videoId || r.video || ""),
        q: String(r.q || r.question || "").trim(),
        a: Array.isArray(r.a) ? r.a.map(x => String(x||"").trim()) : 
           Array.isArray(r.answers) ? r.answers.map(x => String(x||"").trim()) :
           ["","","",""],
        c: typeof r.c === "number" ? clamp(r.c, 0, 3) :
           typeof r.correct === "number" ? clamp(r.correct, 0, 3) : 0
      };
      
      // Ensure 4 answers
      while(normalized.a.length < 4) normalized.a.push("");
      normalized.a = normalized.a.slice(0,4);
      
      if(!isValidRound(normalized)){
        alert(`Ronde ${i+1} mist video, vraag of minimaal 2 antwoorden.`);
        return null;
      }
      
      validRounds.push(normalized);
    }
    
    if(validRounds.length === 0){
      alert("Geen geldige rondes gevonden.");
      return null;
    }
    
    return validRounds;
  }

  // Import: Replace all rounds
  el("importReplace").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    
    const newRounds = parseImportData();
    if(!newRounds) return;
    
    if(!confirm(`${newRounds.length} ronde(s) gevonden. Alle bestaande rondes vervangen?`)){
      return;
    }
    
    rounds = newRounds;
    idx = 0;
    persistRounds();
    loadRound();
    
    el("importArea").classList.remove("show");
    el("importData").value = "";
    alert(`${newRounds.length} ronde(s) ge√Ømporteerd!`);
  });

  // Import: Add to existing rounds
  el("importAdd").addEventListener("click", () => {
    if(!teacherUnlocked) return;
    
    const newRounds = parseImportData();
    if(!newRounds) return;
    
    if(!confirm(`${newRounds.length} ronde(s) toevoegen aan de bestaande ${rounds.length} ronde(s)?`)){
      return;
    }
    
    rounds = rounds.concat(newRounds);
    persistRounds();
    loadRound();
    
    el("importArea").classList.remove("show");
    el("importData").value = "";
    alert(`${newRounds.length} ronde(s) toegevoegd! Totaal: ${rounds.length} rondes.`);
  });

  // ============================
  // END EXPORT / IMPORT
  // ============================

  function loadRound(){
    idx = clamp(idx, 0, rounds.length - 1);
    const r = rounds[idx];

    el("roundInfo").textContent = `Ronde ${idx+1}/${rounds.length}`;
    el("tpRoundInfo").textContent = `${idx+1}/${rounds.length}`;
    setVideo(r.videoId || "");

    el("prev").disabled = (idx === 0);
    el("next").disabled = (idx === rounds.length - 1);
    el("moveUp").disabled = (idx === rounds.length - 1);
    el("moveDown").disabled = (idx === 0);

    writeTeacher(r);
    resetRoundUI();
  }

  function awardPoint(t){
    if(t==="A") scoreA++; else scoreB++;
    el("scoreA").textContent = String(scoreA);
    el("scoreB").textContent = String(scoreB);
    localStorage.setItem(SCORE_KEY, JSON.stringify({a:scoreA, b:scoreB}));
  }

  function choose(n){
    if(!buzzedTeam || answered) return;

    const r = rounds[idx];
    answered = true;
    const correct = (n === r.c);
    renderAnswers(n);

    if(correct){
      awardPoint(buzzedTeam);
    } else {
      // Wrong answer - opponent gets the point
      const opponent = (buzzedTeam === "A") ? "B" : "A";
      awardPoint(opponent);
    }
    
    // Check if last round
    if(idx >= rounds.length - 1){
      setTimeout(showWinner, 1000);
    } else {
      setTimeout(nextAuto, 900);
    }
  }

  function showWinner(){
    const nameA = el("nameAInput").value.trim() || "Team A";
    const nameB = el("nameBInput").value.trim() || "Team B";
    
    let title, name;
    if(scoreA > scoreB){
      title = "Winnaar!";
      name = nameA;
    } else if(scoreB > scoreA){
      title = "Winnaar!";
      name = nameB;
    } else {
      title = "Gelijkspel!";
      name = nameA + " & " + nameB;
    }
    
    el("winnerTitle").textContent = title;
    el("winnerName").textContent = name;
    el("winnerScore").textContent = scoreA + " - " + scoreB;
    el("winnerModal").classList.add("show");
  }

  el("closeWinner").addEventListener("click", () => {
    el("winnerModal").classList.remove("show");
  });

  function nextAuto(){
    if(idx < rounds.length - 1){
      idx++;
      loadRound();
    }else{
      loadRound();
    }
  }

  el("prev").addEventListener("click", ()=>{ idx = Math.max(0, idx-1); loadRound(); });
  el("next").addEventListener("click", ()=>{ idx = Math.min(rounds.length-1, idx+1); loadRound(); });

  el("moveUp").addEventListener("click", ()=>{
    if(!teacherUnlocked || idx >= rounds.length-1) return;
    const temp = rounds[idx];
    rounds[idx] = rounds[idx+1];
    rounds[idx+1] = temp;
    idx++;
    persistRounds();
    loadRound();
  });

  el("moveDown").addEventListener("click", ()=>{
    if(!teacherUnlocked || idx <= 0) return;
    const temp = rounds[idx];
    rounds[idx] = rounds[idx-1];
    rounds[idx-1] = temp;
    idx--;
    persistRounds();
    loadRound();
  });

  el("resetScore").addEventListener("click", ()=>{
    scoreA = 0; scoreB = 0;
    el("scoreA").textContent = "0";
    el("scoreB").textContent = "0";
    localStorage.setItem(SCORE_KEY, JSON.stringify({a:scoreA, b:scoreB}));
  });

  window.addEventListener("keydown", (e)=>{
    // A key = Team A (left) buzzes in
    if(e.key.toLowerCase()==="a" && !e.ctrlKey && !e.metaKey){
      buzzIn("A");
      return;
    }
    // L key = Team B (right) buzzes in
    if(e.key.toLowerCase()==="l"){
      buzzIn("B");
      return;
    }
    // 1-4 to select answer (only after buzz)
    if(buzzedTeam && !answered){
      if(e.key==="1") choose(0);
      if(e.key==="2") choose(1);
      if(e.key==="3") choose(2);
      if(e.key==="4") choose(3);
    }
    if(e.key.toLowerCase()==="x") stopVideo();
    if(e.key.toLowerCase()==="p") playVideo();
  });

  setLockUI();
  loadRound();

  // ============================
  // TOURNAMENT SYSTEM
  // ============================
  const TOURNAMENT_KEY = "kennis_battle_tournament_v1";
  
  let tournament = null;
  
  function loadTournament(){
    try{
      tournament = JSON.parse(localStorage.getItem(TOURNAMENT_KEY));
    }catch(_){ tournament = null; }
  }
  
  function saveTournament(){
    localStorage.setItem(TOURNAMENT_KEY, JSON.stringify(tournament));
  }
  
  function clearTournament(){
    tournament = null;
    localStorage.removeItem(TOURNAMENT_KEY);
  }

  el("tournamentBtn").addEventListener("click", () => {
    el("tournamentPanel").classList.toggle("open");
    loadTournament();
    renderTournament();
  });
  
  el("tournamentClose").addEventListener("click", () => {
    el("tournamentPanel").classList.remove("open");
  });

  el("startTournament").addEventListener("click", () => {
    const text = el("playerList").value.trim();
    const players = text.split("\n").map(s => s.trim()).filter(Boolean);
    
    if(players.length < 2){
      alert("Minimaal 2 spelers nodig");
      return;
    }
    
    // Shuffle players
    for(let i = players.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [players[i], players[j]] = [players[j], players[i]];
    }
    
    tournament = {
      players: players.map(name => ({ name, wins: 0, losses: 0, eliminated: false })),
      winners: [...Array(players.length).keys()], // indices of players in winners bracket
      losers: [], // indices of players in losers bracket
      currentBracket: "winners", // "winners" or "losers"
      round: 1,
      matchIndex: 0,
      finished: false,
      champion: null
    };
    
    saveTournament();
    renderTournament();
  });

  el("winnerA").addEventListener("click", () => recordMatchWinner(0));
  el("winnerB").addEventListener("click", () => recordMatchWinner(1));
  
  el("loadMatch").addEventListener("click", () => {
    updateMainGamePlayers();
    // Reset to first round
    idx = 0;
    loadRound();
  });
  
  el("resetTournament").addEventListener("click", () => {
    if(!confirm("Toernooi resetten?")) return;
    clearTournament();
    renderTournament();
  });
  
  el("newTournament").addEventListener("click", () => {
    clearTournament();
    renderTournament();
  });

  function getCurrentMatch(){
    if(!tournament || tournament.finished) return null;
    
    const bracket = tournament.currentBracket === "winners" ? tournament.winners : tournament.losers;
    const idx = tournament.matchIndex * 2;
    
    if(idx + 1 >= bracket.length) return null;
    
    return {
      playerA: tournament.players[bracket[idx]],
      playerB: tournament.players[bracket[idx + 1]],
      indexA: bracket[idx],
      indexB: bracket[idx + 1]
    };
  }

  function recordMatchWinner(winnerSide){
    if(!tournament || tournament.finished) return;
    
    const match = getCurrentMatch();
    if(!match) return;
    
    const winnerIdx = winnerSide === 0 ? match.indexA : match.indexB;
    const loserIdx = winnerSide === 0 ? match.indexB : match.indexA;
    
    tournament.players[winnerIdx].wins++;
    tournament.players[loserIdx].losses++;
    
    // Move loser based on bracket
    if(tournament.currentBracket === "winners"){
      // Loser goes to losers bracket
      tournament.losers.push(loserIdx);
    } else {
      // In losers bracket - loser is eliminated
      tournament.players[loserIdx].eliminated = true;
    }
    
    // Advance to next match
    tournament.matchIndex++;
    
    const bracket = tournament.currentBracket === "winners" ? tournament.winners : tournament.losers;
    const totalMatches = Math.floor(bracket.length / 2);
    
    if(tournament.matchIndex >= totalMatches){
      // Round finished - prepare next round
      advanceToNextRound();
    }
    
    saveTournament();
    renderTournament();
    
    // Also update the main game with current match players
    updateMainGamePlayers();
  }

  function advanceToNextRound(){
    // Filter out losers from winners bracket
    const remainingWinners = tournament.winners.filter(idx => 
      tournament.currentBracket !== "winners" || !tournament.losers.includes(idx)
    );
    
    // Get active players in each bracket
    const activeWinners = tournament.winners.filter(idx => !tournament.losers.includes(idx));
    const activeLosers = tournament.losers.filter(idx => !tournament.players[idx].eliminated);
    
    tournament.winners = activeWinners;
    tournament.losers = activeLosers;
    
    // Check for tournament end
    const totalActive = activeWinners.length + activeLosers.length;
    
    if(totalActive <= 1){
      // Tournament finished
      tournament.finished = true;
      const champIdx = activeWinners[0] ?? activeLosers[0];
      tournament.champion = tournament.players[champIdx]?.name || "?";
      saveTournament();
      return;
    }
    
    // Determine next bracket and round
    if(tournament.currentBracket === "winners"){
      if(activeLosers.length >= 2){
        // Play losers bracket
        tournament.currentBracket = "losers";
      } else {
        // Continue winners
        tournament.round++;
      }
    } else {
      // After losers bracket, back to winners
      tournament.currentBracket = "winners";
      tournament.round++;
    }
    
    tournament.matchIndex = 0;
    
    // Check if current bracket has enough players
    const currentBracket = tournament.currentBracket === "winners" ? tournament.winners : tournament.losers;
    if(currentBracket.length < 2){
      // Switch to other bracket or end
      if(tournament.currentBracket === "winners" && activeLosers.length >= 2){
        tournament.currentBracket = "losers";
      } else if(tournament.currentBracket === "losers" && activeWinners.length >= 2){
        tournament.currentBracket = "winners";
      } else {
        // Final match between last winner and last loser survivor
        if(activeWinners.length === 1 && activeLosers.length === 1){
          tournament.winners = [activeWinners[0], activeLosers[0]];
          tournament.currentBracket = "winners";
          tournament.losers = [];
        }
      }
    }
  }

  function updateMainGamePlayers(){
    const match = getCurrentMatch();
    if(match){
      el("nameAInput").value = match.playerA.name;
      el("nameBInput").value = match.playerB.name;
      saveNames();
      // Reset scores for new match
      scoreA = 0;
      scoreB = 0;
      el("scoreA").textContent = "0";
      el("scoreB").textContent = "0";
      localStorage.setItem(SCORE_KEY, JSON.stringify({a:0, b:0}));
    }
  }

  function renderTournament(){
    if(!tournament){
      el("tournamentSetup").style.display = "block";
      el("tournamentBracket").style.display = "none";
      el("tournamentWinner").style.display = "none";
      return;
    }
    
    if(tournament.finished){
      el("tournamentSetup").style.display = "none";
      el("tournamentBracket").style.display = "none";
      el("tournamentWinner").style.display = "block";
      el("finalWinnerName").textContent = tournament.champion;
      return;
    }
    
    el("tournamentSetup").style.display = "none";
    el("tournamentBracket").style.display = "block";
    el("tournamentWinner").style.display = "none";
    
    // Update bracket info
    const bracketName = tournament.currentBracket === "winners" ? "Winners" : "Losers";
    el("bracketInfo").textContent = `Ronde ${tournament.round} - ${bracketName} Bracket`;
    
    // Update current match
    const match = getCurrentMatch();
    if(match){
      el("matchPlayerA").textContent = match.playerA.name;
      el("matchPlayerB").textContent = match.playerB.name;
      el("winnerA").disabled = false;
      el("winnerB").disabled = false;
      el("loadMatch").disabled = false;
    } else {
      el("matchPlayerA").textContent = "-";
      el("matchPlayerB").textContent = "-";
      el("winnerA").disabled = true;
      el("winnerB").disabled = true;
      el("loadMatch").disabled = true;
    }
    
    // Update standings
    const standings = el("bracketStandings");
    const sorted = [...tournament.players].sort((a, b) => {
      if(a.eliminated !== b.eliminated) return a.eliminated ? 1 : -1;
      return b.wins - a.wins;
    });
    
    standings.innerHTML = `
      <div class="standingsTitle">Stand</div>
      <div class="standingsList">
        ${sorted.map(p => `
          <div class="standingItem ${p.eliminated ? 'eliminated' : ''} ${tournament.champion === p.name ? 'winner' : ''}">
            <span>${p.name}</span>
            <span class="wins">${p.wins}W - ${p.losses}L</span>
          </div>
        `).join("")}
      </div>
    `;
  }

  // Load tournament on init
  loadTournament();
})();
</script>
</body>
</html>
